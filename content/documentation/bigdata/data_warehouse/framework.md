---
title: 3.4. 数仓架构
weight: 4
#next: /step1
prev: /data_warehouse
editURL: "https://example.com/edit/this/page"
type: "docs" # 点击后任然显示左边目录
toc: true
math: true
---

## 1. 架构概述

| 架构维度          | 定位                     | 核心任务                                                                 | 关键交付物                  | 依赖关系                     |
|:-------------------:|:--------------------------:|--------------------------------------------------------------------------|:-----------------------------:|:------------------------------:|
| **业务架构**<br>（战略层） | 为什么建数仓？<br>（价值定义） | - 明确组织真实诉求（数据资产/数据应用）<br>- 识别服务对象（高管/业务部门）<br>- 制定数据战略目标 | 业务需求说明书<br>数据治理框架 | 驱动所有其他架构设计         |
| **应用架构**<br>（战术层） | 如何实现业务需求？<br>（系统蓝图） | - 功能模块划分：<br> ▪ 数据接入层<br> ▪ 数据存储层<br> ▪ 管理工具（元数据/质量监控）<br> ▪ 数据服务层（BI/API） | 系统架构图<br>接口规范文档  | 承接业务需求<br>约束数据模型设计 |
| **数据架构**<br>（模型层） | 数据如何结构化？<br>（逻辑设计） | - 分层建模（ODS→DWD→DWS→ADS）<br>- 主题域划分（如销售、供应链）<br>- 标准化定义（字段命名/计算口径） | 数据模型ER图<br>数据字典    | 受应用功能约束<br>指导ETL开发 |
| **技术架构**<br>（实现层） | 如何技术落地？<br>（工具选型） | - 技术栈选型（Hadoop/云数仓）<br>- 组件集成（Spark+Kafka+Airflow）<br>- 性能优化（索引/缓存策略） | 技术方案书<br>系统拓扑图    | 支撑数据模型<br>决定部署方案 |
| **ETL架构**<br>（流水线层） | 数据如何加工？<br>（流程设计） | - 处理流程（抽取→转换→加载）<br>- 任务调度（依赖关系/优先级）<br>- 容错处理（重试/报警机制） | ETL流程图<br>调度配置表     | 实现数据模型<br>依赖技术组件 |
| **部署架构**<br>（物理层） | 系统如何安装？<br>（资源配置） | - 环境规划（开发/测试/生产）<br>- 硬件配置（服务器/存储/网络）<br>- 高可用部署（集群/容灾） | 部署方案书<br>资源清单      | 依赖技术选型<br>保障系统运行 |

<br>

## 2. 架构详述

### 2.1、业务架构（战略层）

1️⃣ 定义：***描述数据仓库如何支持业务目标和业务流程***。

2️⃣ 关键要素：
1. ***业务目标对齐***：明确数据仓库要解决的业务问题
2. 利益相关者分析：识别业务用户、决策者等角色
3. KPI体系：确定关键绩效指标和度量标准
4. ***数据治理框架***：数据所有权、质量标准等
5. 价值流分析：数据如何为业务创造价值

3️⃣ 关键交付物：***业务需求说明书***，***数据治理框架***


```mermaid
graph TD
    %% 战略目标
    A[企业数字化战略] --> B[数据资产化]
    A --> C[数据服务化]
    
    %% 数据资产管理
    B --> B1[数据治理]
    B1 --> B11((元数据管理))
    B1 --> B12((数据质量标准))
    B1 --> B13((数据安全))
    
    %% 数据应用场景
    C --> C1[经营分析]
    C1 --> C11[财务看板]
    C1 --> C12[销售漏斗]
    
    C --> C2[用户运营]
    C2 --> C21[用户分群]
    C2 --> C22[行为分析]
    
    C --> C3[风险控制]
    C3 --> C31[实时反欺诈]
    C3 --> C32[信用评分]
```

<br>


### 2.2、应用架构（战术层）

1️⃣ 定义：***描述数据仓库系统中的功能模块和应用组件***。

2️⃣ 关键要素：
- 功能模块划分：
  1. 数据采集
  2. 数据处理
  3. 数据存储
  4. 数据分析
  5. 数据服务

- 应用组件：
  1. ETL/ELT工具
  2. BI工具
  3. 报表系统
  4. 数据挖掘工具
  5. 数据目录

3️⃣ 关键交付物：系统架构图，接口规范文档。


```mermaid
graph LR
    %% 数据源层
    S1[业务数据库] -->|CDC| ETL
    S2[日志文件] -->|Flume| ETL
    S3[第三方API] -->|Http| ETL
    
    %% 数据处理层
    subgraph 数据平台
        ETL[ETL引擎] --> DQ[数据质量检测]
        DQ -->|合格数据| DW[(数据仓库)]
        DW -->|元数据| Meta[元数据管理系统]
    end
    
    %% 数据服务层
    DW --> ADS[数据服务层]
    ADS --> BI[BI工具]
    ADS --> API[数据API网关]
    ADS --> AI[AI模型服务]
    
    %% 管理工具
    Meta -->|血缘分析| Gov[数据治理平台]
    Gov -->|审计| Sec[安全中心]
```


<br>


### 2.3、数据架构（模型层）

1️⃣ 定义：***描述数据的组织、结构和流动***。

2️⃣ 关键要素：
- 数据分层：
  1. ODS (操作数据存储)
  2. DWD (数据仓库明细层)
  3. DWM (数据仓库中间层)
  4. DWS (数据仓库汇总层)
  5. ADS (应用数据服务层)

- 数据模型：
  1. 星型模型
  2. 雪花模型
  3. 星座模型
  4. 数据宽表

3️⃣ 数据生命周期管理

4️⃣	主数据管理

5️⃣ 元数据管理

6️⃣ 数据质量框架

7️⃣ 数据模型ER图，数据字典

```mermaid
flowchart LR
    %% 数据流
    ODS[ODS层<BR>原始数据保留] -->|解析| STG[STG层<BR>临时存储]
    STG -->|清洗| DWD[DWD层<BR>明细事实表]
    DWD -->|join维度| DIM[DIM<BR>维度表]
    DWD -->|聚合| DWS[DWS层<BR>主题宽表]
    DWS -->|业务逻辑| ADS[ADS层<BR>应用指标]
    
    %% 辅助系统
    DIM -->|维度一致性| MDM[主数据管理]
    ADS -->|指标定义| Metric[指标管理系统]
```


<br>


### 2.4、技术架构（实现层）

1️⃣ 定义：***描述实现数据仓库的技术组件和基础设施***。

2️⃣ 关键要素：


| 分类              | 工具/技术                                                                 |
|-------------------|--------------------------------------------------------------------------|
| 技术栈选择         | 传统RDBMS (Oracle, Teradata)<br>大数据平台 (Hadoop, Spark)<br>云数据仓库 (Snowflake, Redshift, BigQuery) |
| 计算与处理框架     | 批处理引擎 (MapReduce，Spark)<br>流处理引擎 (Flink, Storm)<br>查询引擎 (Presto, Druid) |
| 存储技术           | 关系型数据库 (MySQL, PostgreSQL)<br>NoSQL数据库 (MongoDB, Cassandra)<br>数据湖存储 (S3, HDFS) |
| 数据管理           | 数据质量 (Great Expectations)<br>元数据 (Atlas, DataHub)<br>主数据 (Informatica MDM) |
| 安全架构           | 认证授权 (Kerberos, IAM)<br>数据加密 (TLS, KMS)<br>审计日志 (Audit Logging) |

```mermaid
graph BT
    %% 基础设施
    I1[物理服务器] --> C1[云计算平台]
    I2[网络设备] --> C1
    
    %% 数据平台
    subgraph 技术栈
        C1 -->|资源| S1[存储层]
        S1 --> S11[HDFS]
        S1 --> S12[S3]
        
        C1 -->|资源| S2[计算层]
        S2 --> S21[Spark]
        S2 --> S22[Flink]
        
        C1 -->|资源| S3[服务层]
        S3 --> S31[Presto]
        S3 --> S32[Airflow]
    end
    
    %% 新增数据管理层
    subgraph 数据管理层
        DM1[元数据管理] --> DM2[数据质量管理]
        DM2 --> DM3[主数据管理]
        DM3 --> DM4[数据血缘追踪]
    end
    
    %% 新增数据安全层
    subgraph 数据安全层
        DS1[身份认证] --> DS2[访问控制]
        DS2 --> DS3[数据加密]
        DS3 --> DS4[审计日志]
    end
    
    %% 集成与关联关系
    S31 --> API[API Gateway]
    S32 -->|调度| ETL[ETL集群]
    
    %% 管理层与各层的连接
    DM1 --> S1
    DM1 --> S2
    DM1 --> S3
    
    %% 安全层与各层的连接
    DS1 --> S1
    DS1 --> S2
    DS1 --> S3
    DS4 --> API
```



<br>


### 2.5、ETL 架构（流水线层）

1️⃣ 定义：***描述数据抽取、转换和加载的过程设计***。

2️⃣ 关键要素：

| 分类 | 工具/技术 |
|---|---|
| 抽取策略 | 全量抽取<br>增量抽取 (CDC)<br>实时流式抽取 |
| 转换逻辑 | 数据清洗<br>数据标准化<br>数据聚合<br>业务规则应用 |
| 加载策略 | 批量加载<br>微批处理<br>实时加载 |
| 调度框架 | 工作流设计<br>依赖管理<br>错误处理<br>重试机制 |


```mermaid
flowchart LR
    %% 任务流
    subgraph 批处理
        A[增量抽取] --> B[数据去重]
        B --> C[字段标准化]
        C --> D[业务规则加工]
        D --> E[质量检查]
        E --> F[分区落地]
    end
    
    subgraph 实时流
        G[Kafka采集] --> H[流式解析]
        H --> I[窗口计算]
        I --> J[实时入库]
    end
    
    %% 调度控制
    F -->|触发| K[下游任务]
    J -->|通知| K
    K --> L[监控告警]
```


<br>


### 2.6、部署架构（物理层）

1️⃣ 定义：***描述数据仓库系统的物理或虚拟部署方案***。

2️⃣ 关键要素：

| 分类 | 工具/技术 |
|---|---|
| 环境规划 | 开发环境<br>测试环境<br>预生产环境<br>生产环境 |
| 部署模式 | 本地部署<br>云部署<br>混合部署 |
| 资源分配 | 计算资源分配<br>存储资源分配<br>网络配置 |
| 高可用设计 | 集群部署<br>故障转移<br>灾备方案 |
| 扩展性设计 | 水平扩展<br>垂直扩展<br>弹性伸缩 |
| 容器化方案 | Docker<br>Kubernetes编排 |

```mermaid
graph TB
    %% 互联网接入
    Internet[互联网] --> FW[防火墙]
    
    %% 主数据中心
    subgraph 主数据中心
        LB[负载均衡] --> M1[主Master节点]
        M1 --> W1[计算节点1]
        M1 --> W2[计算节点2]
        M1 --> W3[计算节点3]
        
        W1 --> NAS[共享存储]
        W2 --> NAS
        W3 --> NAS
    end

    %% 数据采集层
    subgraph 数据采集
        F1[Flume]
        S1[Sqoop]
        K1[Kafka]
    end

    %% 灾备中心
    subgraph 灾备中心
        M2[备Master节点]
        M2 --> W4[备用节点]
    end

    %% 服务组件
    DB[元数据库] --> M1
    MQ[消息队列] --> W1
    MQ --> W2
    MQ --> W3

    %% 正确的数据流向
    ETL[数据源] --> F1 --> NAS
    ETL --> S1 --> NAS
    ETL --> K1 --> NAS
    
    NAS -->|数据同步| BCK[备份存储]
    
    %% 同步关系
    M1 -.->|心跳检测| M2
    DB -.->|数据复制| M2

    %% 样式
    style M1 fill:#ffcccc
    style M2 fill:#ffcccc
    style W1 fill:#ccffcc
    style W2 fill:#ccffcc
    style W3 fill:#ccffcc
    style W4 fill:#ccccff
    style NAS fill:#ffffcc
    style F1 fill:#ffccff
    style S1 fill:#ffccff
    style K1 fill:#ffccff
```

<br>


## 3. 架构间关系

***架构间关系总结（依赖与影响）***

- 业务架构是核心驱动力，直接影响应用架构和数据架构。
- 应用架构决定系统功能划分，并依赖数据架构提供数据支持。
- 数据架构需要技术架构提供存储和计算能力，并指导ETL架构的数据加工逻辑。
- 技术架构决定部署架构的硬件/云资源分配。
- ETL架构是数据流动的管道，连接数据架构和技术架构。
- 部署架构是最终落地，确保所有组件高效稳定运行。

```mermaid
graph LR
    A[业务架构] --> B[应用架构]
    B --> C[数据架构]
    C --> D[ETL架构]
    B --> E[技术架构]
    C --> E
    E --> F[部署架构]
    
    %% 样式设置
    style A fill:#e1f5fe,stroke:#01579b,stroke-width:2px
    style B fill:#f3e5f5,stroke:#4a148c,stroke-width:2px
    style C fill:#e8f5e8,stroke:#1b5e20,stroke-width:2px
    style D fill:#fff3e0,stroke:#e65100,stroke-width:2px
    style E fill:#fbe9e7,stroke:#bf360c,stroke-width:2px
    style F fill:#e0f2f1,stroke:#00695c,stroke-width:2px
```


***核心依赖路径：***

- 业务架构 → 应用架构：业务需求驱动应用功能设计
- 应用架构 → 数据架构：应用需求决定数据模型结构
- 数据架构 → ETL架构：数据模型指导ETL开发流程
- 技术架构 → 部署架构：技术选型决定部署方案

***交叉依赖关系：***

- 应用架构 → 技术架构：应用特性影响技术选型
- 数据架构 → 技术架构：数据规模影响技术方案
- ETL架构 → 技术架构：ETL流程依赖技术组件

***各架构职责：***

- 业务架构：定义为什么做（战略层）
- 应用架构：定义做什么（战术层）
- 数据架构：定义数据如何组织（设计层）
- ETL架构：定义数据如何加工（执行层）
- 技术架构：定义用什么技术（支撑层）
- 部署架构：定义如何部署实施（物理层）


<br>


## 4. 数据架构\数仓架构

### 4.1、数仓架构发展

```mermaid
timeline
    title 数据仓库架构演进时间线
    section 传统数仓 (1990s - 2000s)
        特点: 集中式、单体
        : 技术栈: Oracle, Teradata, DB2<br>ETL工具: Informatica, DataStage
    section 分布式数仓 (2010s 早期)
        特点: 分而治之、MPP
        : 技术栈: Greenplum, Teradata ASTER<br>Netezza, Exadata
    section 大数据数仓 (2010s 中期)
        特点: 廉价硬件、Scale-Out
        : 技术栈: Hadoop (Hive), Spark SQL<br>设计模式: 分层建模 (ODS-DWD-DWS-ADS)
    section 实时数仓 (2010s 中后期)
        特点: 低延迟、流处理
        : 技术栈: Kafka, Storm, Spark Streaming<br>Flink, Druid, ClickHouse
    section 流批一体架构
        Lambda (2010s 末) 
          : 批流分离、合并结果
          : 批层 \n Hadoop/Spark
          : 批层 Storm/Flink
        Kappa (2010s 末) 全流处理、重放历史
          
          : 技术栈: Kafka + Flink
    section 数据湖 & 湖仓一体 (2020s+)
        特点: 灵活性、统一治理
        : 技术栈: S3/OSS, Delta Lake<br>Iceberg, Hudi, Snowflake<br>BigQuery, Databricks
```



| 架构阶段 | 核心诉求 | 关键技术 | 优点 | 缺点 |
|---------|---------|----------|------|------|
| **传统数仓** | 集中式管理、BI报表 | Teradata、Oracle、ETL工具 | 强一致性、SQL支持好、稳定 | 扩展性差、成本极高、无法处理非结构化数据 |
| **分布式数仓** | 处理更大数据量 | Greenplum、Netezza (MPP架构) | 性能比传统数仓强、兼容性好 | 扩展仍有上限、成本依然较高 |
| **大数据数仓** | 处理海量多源数据、降低成本 | Hadoop、Hive、Spark | scale-out扩展性强、成本低 | 延迟高（T+1）、技术栈复杂、数据质量挑战大 |
| **实时数仓** | 低延迟、实时分析与决策 | Kafka、Flink、ClickHouse、Druid | 延迟低至秒/毫秒级、实时业务价值 | 架构复杂（需对接批和实时两条链路）、数据口径可能不一致 |
| **Lambda架构** | 兼顾实时与历史数据的准确性 | **批层**：Hadoop/Spark<br>**速层**：Flink/Storm<br>**服务层**：Druid | 平衡准确性与实时性 | 两套代码、开发运维成本高、需要合并批流结果 |
| **Kappa架构** | 简化Lambda的复杂性 | Kafka（存储历史数据）、Flink | 一套代码处理批和流、架构简化 | 消息队列历史数据重处理成本高、对消息队列要求高 |
| **数据湖** | 数据民主化、探索式分析 | S3/OSS、Hudi、Iceberg、Delta Lake | 原始数据存储、灵活性极高、支持多种计算引擎 | 缺乏强Schema管理、易变成"数据沼泽"、事务支持弱 |
| **湖仓一体** | 融合湖的灵活与仓的管理 | **存储层**：S3/OSS<br>**管理层**：Delta/Iceberg<br>**计算层**：Spark/Flink | 最佳平衡点：兼具灵活性、性能、成本和管理 | 技术仍在快速发展中、架构复杂度较高 |









